# Security Vulnerability Examples

Detailed code examples for common security vulnerabilities and their fixes.

## Universal Security Vulnerabilities

### 1. SQL Injection

#### Python Example
```python
# üö® CRITICAL: SQL Injection
# ‚ùå Vulnerable
def get_user(username):
    query = f"SELECT * FROM users WHERE username = '{username}'"
    return db.execute(query)
# Attack: username = "admin' OR '1'='1"

# ‚úÖ Fixed: Parameterized query
def get_user(username):
    query = "SELECT * FROM users WHERE username = ?"
    return db.execute(query, (username,))
```

#### Java Example
```java
// üö® CRITICAL: SQL Injection
// ‚ùå Vulnerable
public User getUser(String username) {
    String query = "SELECT * FROM users WHERE username = '" + username + "'";
    return jdbcTemplate.queryForObject(query, User.class);
}

// ‚úÖ Fixed: PreparedStatement
public User getUser(String username) {
    String query = "SELECT * FROM users WHERE username = ?";
    return jdbcTemplate.queryForObject(query, new Object[]{username}, User.class);
}
```

### 2. Command Injection

#### JavaScript/Node.js Example
```javascript
// üö® HIGH: Command Injection
// ‚ùå Vulnerable
app.post('/convert', (req, res) => {
  exec(`convert ${req.body.file} output.pdf`);
});
// Attack: file = "input.txt; rm -rf /"

// ‚úÖ Fixed: Whitelist and sanitize
const path = require('path');
app.post('/convert', (req, res) => {
  const file = path.basename(req.body.file);  // Prevent path traversal
  if (!/^[a-zA-Z0-9_-]+\.txt$/.test(file)) {  // Whitelist pattern
    return res.status(400).send('Invalid file');
  }
  exec(`convert ${file} output.pdf`);
});
```

#### Python Example
```python
# üö® HIGH: Command Injection
# ‚ùå Vulnerable
import os
def process_file(filename):
    os.system(f"cat {filename}")  # Shell injection possible

# ‚úÖ Fixed: Use subprocess with array
import subprocess
def process_file(filename):
    subprocess.run(["cat", filename], check=True)  # No shell interpretation
```

### 3. XSS (Cross-Site Scripting)

#### React Example
```javascript
// üö® HIGH: XSS vulnerability
// ‚ùå Vulnerable
function UserProfile({ user }) {
  return <div dangerouslySetInnerHTML={{ __html: user.bio }} />;
}
// Attack: bio = "<script>alert('XSS')</script>"

// ‚úÖ Fixed: Sanitize or avoid HTML
function UserProfile({ user }) {
  return <div>{user.bio}</div>;  // React escapes by default
}

// If HTML needed, use DOMPurify:
import DOMPurify from 'dompurify';
function UserProfile({ user }) {
  const sanitizedBio = DOMPurify.sanitize(user.bio);
  return <div dangerouslySetInnerHTML={{ __html: sanitizedBio }} />;
}
```

#### PHP Example
```php
<!-- üö® HIGH: XSS vulnerability -->
<!-- ‚ùå Vulnerable -->
<div><?php echo $_GET['name']; ?></div>

<!-- ‚úÖ Fixed: HTML escape -->
<div><?php echo htmlspecialchars($_GET['name'], ENT_QUOTES, 'UTF-8'); ?></div>
```

### 4. Authentication & Authorization

#### Missing Authorization Check
```java
// üö® CRITICAL: Missing authorization check
// ‚ùå Vulnerable
@GetMapping("/user/{id}/private-data")
public PrivateData getPrivateData(@PathVariable Long id) {
    return privateDataRepository.findByUserId(id);
    // Anyone can access any user's private data!
}

// ‚úÖ Fixed: Authorization check
@GetMapping("/user/{id}/private-data")
public PrivateData getPrivateData(@PathVariable Long id) {
    Long currentUserId = getCurrentUserId();
    if (!currentUserId.equals(id) && !hasAdminRole()) {
        throw new UnauthorizedException("Access denied");
    }
    return privateDataRepository.findByUserId(id);
}
```

#### Weak Password Storage
```python
# üö® CRITICAL: Plain text password
# ‚ùå Vulnerable
def create_user(username, password):
    user = User(username=username, password=password)  # Plain text!
    db.save(user)

# ‚úÖ Fixed: Hashed password with salt
import bcrypt
def create_user(username, password):
    hashed = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
    user = User(username=username, password_hash=hashed)
    db.save(user)
```

### 5. Sensitive Data Exposure

#### Logging Sensitive Data
```typescript
// üõ°Ô∏è MEDIUM: Sensitive data in logs
// ‚ùå Problematic
logger.info(`User logged in: ${JSON.stringify(user)}`);
// Logs: { id: 1, email: "user@example.com", password: "hashed...", ssn: "123-45-6789" }

// ‚úÖ Fixed: Sanitized logging
function sanitizeForLog(user) {
  return {
    id: user.id,
    email: user.email,
    // Omit sensitive fields
  };
}
logger.info(`User logged in: ${JSON.stringify(sanitizeForLog(user))}`);
```

#### Hardcoded Secrets
```go
// üõ°Ô∏è MEDIUM: Hardcoded secrets
// ‚ùå Vulnerable
const apiKey = "sk_live_abc123xyz"  // Secret in source code!

// ‚úÖ Fixed: Environment variable
apiKey := os.Getenv("API_KEY")
if apiKey == "" {
    log.Fatal("API_KEY environment variable required")
}
```

### 6. Path Traversal

```python
# üö® HIGH: Path Traversal
# ‚ùå Vulnerable
@app.route('/download/<filename>')
def download_file(filename):
    return send_file(f"/uploads/{filename}")
# Attack: filename = "../../etc/passwd"

# ‚úÖ Fixed: Validate and sanitize
import os
@app.route('/download/<filename>')
def download_file(filename):
    # Remove any path components
    safe_filename = os.path.basename(filename)
    # Whitelist allowed characters
    if not re.match(r'^[a-zA-Z0-9_.-]+$', safe_filename):
        abort(400, "Invalid filename")

    filepath = os.path.join('/uploads', safe_filename)
    # Verify resolved path is within uploads directory
    if not os.path.abspath(filepath).startswith('/uploads'):
        abort(403, "Access denied")

    return send_file(filepath)
```

### 7. CSRF (Cross-Site Request Forgery)

```python
# üõ°Ô∏è MEDIUM: Missing CSRF protection
# ‚ùå Vulnerable (Flask)
@app.route('/transfer', methods=['POST'])
def transfer_money():
    amount = request.form['amount']
    to_account = request.form['account']
    transfer(amount, to_account)

# ‚úÖ Fixed: CSRF token
from flask_wtf.csrf import CSRFProtect
csrf = CSRFProtect(app)

@app.route('/transfer', methods=['POST'])
@csrf.csrf_protect
def transfer_money():
    amount = request.form['amount']
    to_account = request.form['account']
    transfer(amount, to_account)
```

### 8. Insecure Deserialization

```java
// üö® CRITICAL: Insecure deserialization
// ‚ùå Vulnerable
ObjectInputStream ois = new ObjectInputStream(userInputStream);
Object obj = ois.readObject();  // Can execute arbitrary code!

// ‚úÖ Fixed: Use safe data formats (JSON, Protocol Buffers)
ObjectMapper mapper = new ObjectMapper();
MyObject obj = mapper.readValue(userInputStream, MyObject.class);
```

### 9. XML External Entity (XXE)

```java
// üö® HIGH: XXE vulnerability
// ‚ùå Vulnerable
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
DocumentBuilder db = dbf.newDocumentBuilder();
Document doc = db.parse(userXML);

// ‚úÖ Fixed: Disable external entities
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
dbf.setFeature("http://xml.org/sax/features/external-general-entities", false);
dbf.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
DocumentBuilder db = dbf.newDocumentBuilder();
Document doc = db.parse(userXML);
```

### 10. Rate Limiting Missing

```typescript
// üõ°Ô∏è HIGH: Missing rate limiting
// ‚ùå Vulnerable
app.post('/api/login', async (req, res) => {
  const user = await authenticate(req.body.username, req.body.password);
  // Brute force attack possible!
});

// ‚úÖ Fixed: Rate limiting
import rateLimit from 'express-rate-limit';

const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 minutes
  max: 5,  // 5 attempts
  message: 'Too many login attempts, please try again later',
  standardHeaders: true,
  legacyHeaders: false,
});

app.post('/api/login', loginLimiter, async (req, res) => {
  const user = await authenticate(req.body.username, req.body.password);
});
```

## Performance Issues

### N+1 Query Problem

```javascript
// ‚ö° HIGH: N+1 query problem
// ‚ùå Problematic
const users = await User.findAll();
for (const user of users) {
  user.posts = await Post.findAll({ where: { userId: user.id } });
  // Executes N queries! (1 for users + N for posts)
}

// ‚úÖ Fixed: Eager loading
const users = await User.findAll({
  include: [{ model: Post }]
});
// Executes 1 query with JOIN
```

### Inefficient Algorithm

```python
# ‚ö° MEDIUM: O(n¬≤) performance
# ‚ùå Problematic
def find_duplicates(items):
    duplicates = []
    for i in range(len(items)):
        for j in range(i + 1, len(items)):
            if items[i] == items[j] and items[i] not in duplicates:
                duplicates.append(items[i])
    return duplicates

# ‚úÖ Fixed: O(n) performance
def find_duplicates(items):
    seen = set()
    duplicates = set()
    for item in items:
        if item in seen:
            duplicates.add(item)
        seen.add(item)
    return list(duplicates)
```

### Memory Leak

```go
// ‚ö° MEDIUM: Memory leak potential
// ‚ùå Problematic
func loadAllUsers() []*User {
    rows, _ := db.Query("SELECT * FROM users")
    // No rows.Close() - connection leak!
    var users []*User
    for rows.Next() {
        var user User
        rows.Scan(&user.ID, &user.Name)
        users = append(users, &user)
    }
    return users
}

// ‚úÖ Fixed: Proper resource cleanup
func loadAllUsers() ([]*User, error) {
    rows, err := db.Query("SELECT * FROM users")
    if err != nil {
        return nil, err
    }
    defer rows.Close()  // Ensures cleanup

    var users []*User
    for rows.Next() {
        var user User
        if err := rows.Scan(&user.ID, &user.Name); err != nil {
            return nil, err
        }
        users = append(users, &user)
    }
    return users, rows.Err()
}
```

## Domain-Specific Security

### Financial Systems

#### Floating Point Precision Error
```java
// üö® CRITICAL: Floating point for money
// ‚ùå Vulnerable
double total = 0.1 + 0.2;  // = 0.30000000000000004

// ‚úÖ Fixed: Use BigDecimal
BigDecimal total = new BigDecimal("0.1").add(new BigDecimal("0.2"));
// = 0.3 exactly
```

#### Missing Transaction Atomicity
```python
# üö® CRITICAL: Non-atomic transaction
# ‚ùå Vulnerable
def transfer_money(from_account, to_account, amount):
    debit(from_account, amount)
    # If crash here, money disappears!
    credit(to_account, amount)

# ‚úÖ Fixed: Atomic transaction
from django.db import transaction

@transaction.atomic
def transfer_money(from_account, to_account, amount):
    debit(from_account, amount)
    credit(to_account, amount)
    # Both or neither
```

### Healthcare Systems

#### Missing Data Encryption
```python
# üö® CRITICAL: Unencrypted patient data
# ‚ùå Vulnerable
patient_data = {
    "ssn": "123-45-6789",
    "diagnosis": "...",
}
db.save(patient_data)  # Stored in plain text!

# ‚úÖ Fixed: Encrypt sensitive fields
from cryptography.fernet import Fernet

encryption_key = os.getenv("ENCRYPTION_KEY")
cipher = Fernet(encryption_key)

patient_data = {
    "ssn": cipher.encrypt(b"123-45-6789"),
    "diagnosis": cipher.encrypt(b"..."),
}
db.save(patient_data)
```

### IoT/Embedded Systems

#### Insecure Firmware Update
```c
// üö® HIGH: No signature verification
// ‚ùå Vulnerable
void update_firmware(uint8_t* firmware_data, size_t len) {
    flash_write(FIRMWARE_START_ADDR, firmware_data, len);
    reboot();
}

// ‚úÖ Fixed: Verify signature
bool verify_signature(uint8_t* data, size_t len, uint8_t* signature);

void update_firmware(uint8_t* firmware_data, size_t len, uint8_t* signature) {
    if (!verify_signature(firmware_data, len, signature)) {
        log_error("Invalid firmware signature");
        return;
    }
    flash_write(FIRMWARE_START_ADDR, firmware_data, len);
    reboot();
}
```

## Database Security

### Overprivileged Database Connection
```java
// üö® CRITICAL: Overprivileged database connection
// ‚ùå Problematic
// Application uses 'root' user with full privileges
// spring.datasource.username=root
// spring.datasource.password=rootpass

// ‚úÖ Fixed: Principle of least privilege
// Create dedicated app user with minimal permissions:
// GRANT SELECT, INSERT, UPDATE ON app_db.* TO 'app_user'@'localhost';
// REVOKE DELETE, DROP, ALTER ON app_db.* FROM 'app_user'@'localhost';
//
// spring.datasource.username=app_user
// spring.datasource.password=secure_pass
```

### Missing Input Validation
```typescript
// üö® HIGH: No validation
// ‚ùå Vulnerable
app.post('/api/users', async (req, res) => {
  const user = await User.create(req.body);  // Accepts any fields!
  res.json(user);
});
// Attack: { "isAdmin": true, "balance": 999999 }

// ‚úÖ Fixed: Whitelist allowed fields
import { body, validationResult } from 'express-validator';

app.post('/api/users',
  body('email').isEmail(),
  body('name').isLength({ min: 1, max: 100 }),
  body('age').optional().isInt({ min: 0, max: 150 }),
  async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }

    // Only allow specific fields
    const { email, name, age } = req.body;
    const user = await User.create({ email, name, age });
    res.json(user);
  }
);
```
